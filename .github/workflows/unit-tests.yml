name: Unit Tests

on:
  push:
    branches: [ main, master ]
  pull_request:

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.19'

      - name: Cache Go build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run unit tests (capture result) and optional coverage
        id: runtests
        run: |
          set +e
          go test ./... -covermode=atomic -coverprofile=coverage.out -v
          rc=$?
          if [ $rc -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
            # compute coverage percent
            total=$(go tool cover -func=coverage.out | grep -E 'total:\s*\(statements\)' | awk '{print $3}')
            echo "percent=$total" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
          fi
          exit 0

      - name: Upload coverage artifact
        if: steps.runtests.outputs.result == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: coverage.out
          path: coverage.out

      - name: Update README with unit status and coverage
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          result="${{ steps.runtests.outputs.result }}"
          wf_link="https://github.com/${GITHUB_REPOSITORY}/actions/workflows/unit-tests.yml"

          # Update UNIT-STATUS badge (always)
          if [ "$result" = "success" ]; then
            status_color="brightgreen"; status_text="success"
          else
            status_color="red"; status_text="failed"
          fi
          status_badge="<a href=\"${wf_link}\">\n    <img alt=\"Unit Tests\" src=\"https://img.shields.io/badge/Unit%20Tests-${status_text}-${status_color}?style=flat\" />\n  </a>"

          tmp_status=$(mktemp)
          awk -v repl="$status_badge" '
            BEGIN{start=0}
            /<!-- UNIT-STATUS:START -->/{print; print repl; start=1; next}
            /<!-- UNIT-STATUS:END -->/{start=0; print; next}
            { if(!start) print }
          ' README.md > "$tmp_status"
          changed=0
          if ! diff -q "$tmp_status" README.md >/dev/null 2>&1; then
            mv "$tmp_status" README.md
            changed=1
          else
            rm -f "$tmp_status"
          fi

          # Update UNIT-COVERAGE badge only on success
          if [ "$result" = "success" ]; then
            percent="${{ steps.runtests.outputs.percent }}"   # e.g. 78.3%
            pnum="${percent%%%}"
            pint="${pnum%.*}"
            color="red"
            if [ "$pint" -ge 90 ]; then color="brightgreen"; 
            elif [ "$pint" -ge 75 ]; then color="green"; 
            elif [ "$pint" -ge 60 ]; then color="yellow"; 
            elif [ "$pint" -ge 40 ]; then color="orange"; fi
            cov_badge="<a href=\"${wf_link}\">\n    <img alt=\"Unit Test Coverage\" src=\"https://img.shields.io/badge/coverage-${pint}%25-${color}?style=flat\" />\n  </a>"

            tmp_cov=$(mktemp)
            awk -v repl="$cov_badge" '
              BEGIN{start=0}
              /<!-- UNIT-COVERAGE:START -->/{print; print repl; start=1; next}
              /<!-- UNIT-COVERAGE:END -->/{start=0; print; next}
              { if(!start) print }
            ' README.md > "$tmp_cov"
            if ! diff -q "$tmp_cov" README.md >/dev/null 2>&1; then
              mv "$tmp_cov" README.md
              changed=1
            else
              rm -f "$tmp_cov"
            fi
          fi

          if [ $changed -eq 1 ]; then
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add README.md
            git commit -m "chore(ci): update unit test badges (${result})"
            # Avoid non-fast-forward errors by rebasing against the remote branch first
            BRANCH="${GITHUB_REF##*/}"
            git fetch origin "$BRANCH"
            # In CI, HEAD can be detached; ensure we are on the branch ref for rebase/push
            git checkout -B "$BRANCH"
            git pull --rebase origin "$BRANCH" || true
            # Try to push; if it races, try once more after another rebase
            if ! git push origin "$BRANCH"; then
              git pull --rebase origin "$BRANCH" || true
              git push origin "$BRANCH"
            fi
          fi
          
      - name: Fail job if tests failed
        if: steps.runtests.outputs.result == 'failure'
        run: |
          echo "Unit tests failed"
          exit 1
